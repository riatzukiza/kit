(include "./macros")

(import-namespace kit)

(include "./inc/shell")

(import-namespace shell)

(require! Path "path")

(macro chain-promise (p ...rest)

       (if (empty? rest)
           p
           `(then-do @p (chain-promise ...@rest))))

(macro dired-shell (path ...body)
       `(shell ...@(map body (b) `(cd [@path] ";" ...@(get b 'contents)))))

(def update-git (path)

  (dired-shell
   path
   (git add ".")
   (git commit "-m"  ["'update triggered from down stream repl repo'"])
   (git push)))

(def update-npm (path)
  (dired-shell
   path
   (rm "-r" "./node_modules")
   (npm install)))

(def compile-sib (path)
  (.then (shell (sibilant  (Path.join path "./sib/*.sibilant" ) 
                     "-o"
                     (Path.join path "./js")
                     ))
         (aprint "done compiling" path)))


(var file-system-path"~/devel/groups/mine/file-system"
     kit-path "~/devel/groups/mine/kit")



(def update-kit ()
  (chain-promise

   (compile-sib file-system-path)
   (compile-sib kit-path)

   (update-git file-system-path)
   (update-git kit-path)

   (update-npm kit-path)

   (compile-sib ".")))

(update-kit )
